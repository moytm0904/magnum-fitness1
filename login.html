<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - Magnum Fitness</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Teko:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #ff8800; --accent-2: #ff5500; --muted: #adb5bd; --bg: #0a0a0a;
            --card: #141414; --border-color: rgba(255, 255, 255, 0.07); --shadow-color: rgba(0, 0, 0, 0.5);
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: #fff; line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        .navbar { background-color: rgba(10, 10, 10, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .navbar-brand { font-family: 'Teko', sans-serif; font-size: 1.8rem; letter-spacing: 1px; }
        .nav-link { color: #fff !important; font-weight: 600; transition: color 0.3s ease; }
        .nav-link:hover { color: var(--accent) !important; }
        .main-content { flex-grow: 1; display: flex; justify-content: center; align-items: center; padding: 2rem 1rem; }
        .form-container { background-color: var(--card); padding: 40px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 10px 30px var(--shadow-color); width: 100%; max-width: 420px; text-align: center; }
        .form-container h1 { font-family: 'Teko', sans-serif; font-size: 2.5rem; color: #fff; margin-bottom: 30px; font-weight: 700; }
        .form-container h1 span { color: var(--accent); }
        .form-row { margin-bottom: 25px; }
        .floating-label-group { position: relative; }
        .floating-label-group input { background-color: transparent; border: none; border-bottom: 2px solid var(--border-color); border-radius: 0; font-size: 1.1em; padding: 12px 2px 5px 2px; width: 100%; transition: border-color 0.3s ease; color: #fff; }
        .floating-label-group label { position: absolute; top: 12px; left: 2px; font-size: 1.1em; color: var(--muted); pointer-events: none; transition: all 0.3s ease; }
        .floating-label-group input:focus { outline: none; border-bottom-color: var(--accent); }
        .floating-label-group input:focus + label, .floating-label-group input:not(:placeholder-shown) + label { top: -14px; left: 0; font-size: 0.85em; color: var(--accent); }
        .password-toggle-icon { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; color: var(--muted); }
        .btn-accent { background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #fff; font-weight: 700; border-radius: 8px; padding: 0.75rem 1.5rem; border: 0; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 136, 0, 0.2); width: 100%; }
        .btn-accent:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(255, 136, 0, 0.3); }
        .sub-link { margin-top: 15px; font-size: 0.9em; }
        .sub-link a { color: var(--accent); text-decoration: none; font-weight: bold; cursor: pointer; }
        footer { background-color: #000; padding: 3rem 1rem; color: var(--muted); text-align: center; border-top: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand text-warning" href="index.html">Magnum Fitness</a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="register.html">Registrarse</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div id="login-view" class="form-container">
            <h1>Iniciar <span>Sesión</span></h1>
            <form id="loginForm">
                <div class="form-row floating-label-group">
                    <input type="email" id="email" required placeholder=" " autocomplete="email">
                    <label for="email">Correo Electrónico</label>
                </div>
                <div class="form-row floating-label-group">
                    <input type="password" id="password" required placeholder=" " autocomplete="current-password">
                    <label for="password">Contraseña</label>
                    <i class="bi bi-eye-slash-fill password-toggle-icon" id="togglePassword"></i>
                </div>
                <div class="form-row"><button type="submit" class="btn btn-accent" id="loginBtn">Continuar</button></div>
                <div class="sub-link"><a id="forgotPasswordLink">¿Olvidaste tu contraseña?</a></div>
                <div class="sub-link mt-2"><p class="mb-0">¿No tienes una cuenta? <a href="register.html">Regístrate aquí</a></p></div>
            </form>
        </div>

        <div id="reset-view-1" class="form-container" style="display: none;">
            <h1>Restablecer <span>Contraseña</span></h1>
            <p class="text-muted">Ingresa tu correo para enviarte un código de verificación.</p>
            <form id="requestResetForm">
                <div class="form-row floating-label-group">
                    <input type="email" id="resetEmail" required placeholder=" ">
                    <label for="resetEmail">Correo Electrónico</label>
                </div>
                <div class="form-row"><button type="submit" class="btn btn-accent" id="sendCodeBtn">Enviar Código</button></div>
                <div class="sub-link"><a class="back-to-login">← Volver a Iniciar Sesión</a></div>
            </form>
        </div>

        <div id="reset-view-2" class="form-container" style="display: none;">
            <h1>Ingresar <span>Código</span></h1>
            <p class="text-muted">Revisa tu correo e ingresa el código de 6 dígitos y tu nueva contraseña.</p>
            <form id="resetPasswordForm">
                <div class="form-row floating-label-group">
                    <input type="text" id="resetCode" required placeholder=" " maxlength="6">
                    <label for="resetCode">Código de 6 Dígitos</label>
                </div>
                <div class="form-row floating-label-group">
                    <input type="password" id="newPassword" required placeholder=" ">
                    <label for="newPassword">Nueva Contraseña</label>
                    <i class="bi bi-eye-slash-fill password-toggle-icon" id="toggleNewPassword"></i>
                </div>
                <div class="form-row"><button type="submit" class="btn btn-accent" id="changePassBtn">Cambiar Contraseña</button></div>
                <div class="sub-link"><a class="back-to-login">← Volver a Iniciar Sesión</a></div>
            </form>
        </div>
    </main>

    <footer class="mt-auto">
        <div class="container"><small class="text-muted">&copy; 2025 Magnum Fitness. Todos los derechos reservados.</small></div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginView = document.getElementById('login-view');
            const resetView1 = document.getElementById('reset-view-1');
            const resetView2 = document.getElementById('reset-view-2');

            // --- Lógica de navegación entre vistas ---
            document.getElementById('forgotPasswordLink').addEventListener('click', e => {
                e.preventDefault();
                loginView.style.display = 'none';
                resetView1.style.display = 'block';
            });
            document.querySelectorAll('.back-to-login').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    resetView1.style.display = 'none';
                    resetView2.style.display = 'none';
                    loginView.style.display = 'block';
                });
            });

            // --- Lógica para mostrar/ocultar contraseña ---
            function setupPasswordToggle(toggleId, inputId) {
                const toggle = document.getElementById(toggleId);
                const input = document.getElementById(inputId);
                toggle.addEventListener('click', () => {
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    toggle.classList.toggle('bi-eye-fill');
                    toggle.classList.toggle('bi-eye-slash-fill');
                });
            }
            setupPasswordToggle('togglePassword', 'password');
            setupPasswordToggle('toggleNewPassword', 'newPassword');

            // --- Lógica del formulario de Login (sin cambios) ---
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const loginBtn = document.getElementById('loginBtn');
                const userEmail = document.getElementById('email').value;
                loginBtn.disabled = true;
                loginBtn.textContent = 'Verificando...';

                fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, password: document.getElementById('password').value })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        localStorage.setItem('userEmailForVerification', userEmail);
                        const savedCart = localStorage.getItem('savedCart');
                        const context = savedCart && JSON.parse(savedCart).length > 0 ? 'login_to_pay' : 'login';
                        localStorage.setItem('verificationContext', context);
                        window.location.href = 'enter-code.html';
                    } else {
                        alert('Error: ' + (data.message || 'Usuario o contraseña incorrectos.'));
                    }
                })
                .finally(() => {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Continuar';
                });
            });

            // --- Lógica para solicitar código de reseteo ---
            document.getElementById('requestResetForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const sendCodeBtn = document.getElementById('sendCodeBtn');
                const email = document.getElementById('resetEmail').value;
                sendCodeBtn.disabled = true;
                sendCodeBtn.textContent = 'Enviando...';

                fetch('/request-password-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Código enviado a tu correo. Revisa tu bandeja de entrada.');
                        resetView1.style.display = 'none';
                        resetView2.style.display = 'block';
                    } else {
                        alert('Error: ' + (data.message || 'No se pudo enviar el código.'));
                    }
                })
                .finally(() => {
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.textContent = 'Enviar Código';
                });
            });

            // --- Lógica para cambiar la contraseña con el código ---
            document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const changePassBtn = document.getElementById('changePassBtn');
                const email = document.getElementById('resetEmail').value;
                const code = document.getElementById('resetCode').value;
                const newPassword = document.getElementById('newPassword').value;
                
                changePassBtn.disabled = true;
                changePassBtn.textContent = 'Cambiando...';

                fetch('/reset-password-with-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, newPassword })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('¡Contraseña cambiada con éxito! Ahora puedes iniciar sesión.');
                        window.location.reload();
                    } else {
                        alert('Error: ' + (data.message || 'No se pudo cambiar la contraseña.'));
                    }
                })
                .finally(() => {
                    changePassBtn.disabled = false;
                    changePassBtn.textContent = 'Cambiar Contraseña';
                });
            });
        });
    </script>
</body>
</html>